<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index</title>
    <link rel="stylesheet" href="./assets/bootstrap/v5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="./assets/fontawesome/v5.15.4/css/all.min.css">
    <link rel="stylesheet" href="./assets/sweetalert2/sweetalert2.min.css">
    <link rel="stylesheet" href="./assets/css/style.css">
    <style>
        .modal-alert-danger{
            padding: 0px 35px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="header">
        <nav class="navbar bg-primary">
            <div class="container-fluid">
                <h2>List of customers</h2>
                <div class="d-flex">
                  <div style="margin-right: 10px">
                      <a href="/histories">
                          <button class="btn btn-outline-light">
                              <i class="fas fa-bars"></i>
                              Transfer History
                          </button>
                      </a>
                  </div>


                    <button id="btnShowCreateModal" class="btn btn-light">
                        <i class="fas fa-plus"></i>
                        Create
                    </button>
                </div>
            </div>
        </nav>
    </div>

    <div class="content">
        <table id="tbCustomer" class="table table-hover">
            <thead>
            <tr>
                <th></th>
                <th>#</th>
                <th>Full name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Balance</th>
                <th>Province</th>
                <th>District</th>
                <th>Ward</th>
                <th>Address</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
</div>

<!-- Modal Create -->
<div id="modalCreate" class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal create customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-alert-danger hide"></div>
                <form id="frmCreateCustomer" class="" method="post">
                    <div class="row mb-3">
                        <div class="col-lg-4">
                            <label for="fullNameCre" class="form-label">Full name</label>
                            <input type="text" class="form-control" id="fullNameCre" name="fullNameCre" />
                        </div>
                        <div class="col-lg-4">
                            <label for="emailCre" class="form-label">Email</label>
                            <input type="email" class="form-control" id="emailCre" name="emailCre" />
                        </div>
                        <div class="col-lg-4">
                            <label for="phoneCre" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phoneCre" name="phoneCre" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-lg-3">
                            <label for="provinceCre" class="form-label">Province</label>
                            <select name="provinceCre" id="provinceCre" class="form-select"></select>
                        </div>
                        <div class="col-lg-3">
                            <label for="districtCre" class="form-label">District</label>
                            <select name="districtCre" id="districtCre" class="form-select"></select>
                        </div>
                        <div class="col-lg-3">
                            <label for="wardCre" class="form-label">Ward</label>
                            <select name="wardCre" id="wardCre" class="form-select"></select>
                        </div>
                        <div class="col-lg-3">
                            <label for="addressCre" class="form-label">Address</label>
                            <input type="text" class="form-control" id="addressCre" name="addressCre" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnCreateCustomer">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal update -->
<div id="modalUpdate" class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal update customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-alert-danger hide"></div>
                <form id="frmUpdateCustomer" class="" method="post">
                    <div class="row mb-3">
                        <div class="col-lg-4">
                            <label for="fullNameCre" class="form-label">Full name</label>
                            <input type="text" class="form-control" id="fullNameUp" name="fullNameUp" />
                        </div>
                        <div class="col-lg-4">
                            <label for="emailCre" class="form-label">Email</label>
                            <input type="email" class="form-control" id="emailUp" name="emailUp" />
                        </div>
                        <div class="col-lg-4">
                            <label for="phoneCre" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phoneUp" name="phoneUp" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-lg-3" id="updatedProvince">
                            <label for="provinceCre" class="form-label">Province</label>
                            <select name="provinceUp" id="provinceUp" class="form-select"></select>
                        </div>
                        <div class="col-lg-3">
                            <label for="districtCre" class="form-label">District</label>
                            <select name="districtUp" id="districtUp" class="form-select"></select>
                        </div>
                        <div class="col-lg-3">
                            <label for="wardCre" class="form-label">Ward</label>
                            <select name="wardUp" id="wardUp" class="form-select">

                            </select>
                        </div>
                        <div class="col-lg-3">
                            <label for="addressUp" class="form-label">Address</label>
                            <input type="text" class="form-control" id="addressUp" name="addressUp" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnUpdateCustomer">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal deposit -->
<div id="modalDeposit" class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal deposit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-alert-danger hide"></div>
                <form id="frmDeposit" class="" method="post">
                    <div class="row mb-3">
                        <div class="col-lg-6">
                            <label for="idDep" class="form-label">Id</label>
                            <input type="text" class="form-control" id="idDep" name="idDep" readonly />
                        </div>
                        <div class="col-lg-6">
                            <label for="fullNameDep" class="form-label">Full name</label>
                            <input type="text" class="form-control" id="fullNameDep" name="fullNameDep" readonly />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="mb-3 col-lg-6">
                            <label for="balanceDep" class="form-label">Balance</label>
                            <input type="text" class="form-control" id="balanceDep" name="balanceDep" readonly />
                        </div>
                        <div class="mb-3 col-lg-6">
                            <label for="transactionAmountDep" class="form-label">TransactionAmount</label>
                            <input type="text" class="form-control" id="transactionAmountDep" name="transactionAmountDep" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-light" id="btnDeposit">Deposit</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal withdraw -->
<div id="modalWithdraw" class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal withdraw</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-alert-danger hide"></div>
                <form id="frmWithdraw" class="" method="post">
                    <div class="row mb-3">
                        <div class="col-lg-6">
                            <label for="idDep" class="form-label">Id</label>
                            <input type="text" class="form-control" id="idWd" name="idDep" readonly />
                        </div>
                        <div class="col-lg-6">
                            <label for="fullNameDep" class="form-label">Full name</label>
                            <input type="text" class="form-control" id="fullNameWd" name="fullNameDep" readonly />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="mb-3 col-lg-6">
                            <label for="balanceDep" class="form-label">Balance</label>
                            <input type="text" class="form-control" id="balanceWd" name="balanceDep" readonly />
                        </div>
                        <div class="mb-3 col-lg-6">
                            <label for="transactionAmountDep" class="form-label">TransactionAmount</label>
                            <input type="text" class="form-control" id="transactionAmountWd" name="transactionAmountDep" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-light" id="btnWithdraw">Withdraw</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Transfer -->
<div class="modal fade" id="modalTransfer" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Modal transfer</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" >
                    <fieldset class="mt-3 g-3">
                        <div class="form-group row">
                            <div class="mb-3 col-md-4">
                                <label class="col-sm-12 col-form-label">Sender ID</label>
                                <div class="col-sm-12">
                                    <input type="text" class="form-control" id="senderIdTrf" name="senderIdTrf" readonly>
                                </div>
                            </div>
                            <div class="mb-3 col-md-4">
                                <label class="col-sm-12 col-form-label">Sender Name</label>
                                <div class="col-sm-12">
                                    <input type="text" class="form-control" id="senderNameTrf" name="senderNameTrf" readonly>
                                </div>
                            </div>
                            <div class="mb-3 col-md-4">
                                <label class="col-sm-12 col-form-label">Email</label>
                                <div class="col-sm-12">
                                    <input type="email" class="form-control" id="emailTrf" name="emailTrf" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="mb-3 col-md-6">
                                <label class="col-sm-12 col-form-label">Sender balance</label>
                                <div class="col-sm-12">
                                    <input type="text" class="form-control num-space" id="balanceTrf" name="balanceTrf" readonly>
                                </div>
                            </div>

                            <div class="mb-3 col-md-6">
                                <label class="col-sm-12 col-form-label">Recipient Name</label>
                                <div class="col-sm-12">
                                    <select class="form-select" id="recipientIdTrf" name="recipientIdTrf"></select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="mb-3 col-md-4">
                                <label class="col-sm-12 col-form-label">Transfer Amount ($)</label>
                                <div class="col-sm-12">
                                    <input type="text" class="form-control num-space" id="transferAmountTrf" name="transferAmountTrf">
                                </div>
                            </div>
                            <div class="mb-3 col-md-4">
                                <label class="col-sm-12 col-form-label">Fees (%)</label>
                                <div class="col-sm-12">
                                    <input type="text" class="form-control num-space" id="feesTrf" name="feesTrf" value="10" readonly>
                                </div>
                            </div>
                            <div class="mb-3 col-md-4">
                                <label class="col-sm-12 col-form-label">Total amount of transaction ($)</label>
                                <div class="col-sm-12">
                                    <input type="text" class="form-control num-dot" id="transactionAmountTrf" name="transactionAmountTrf" readonly>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="btnTransfer" class="btn btn-outline-primary">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
            </div>
        </div>
    </div>
</div>

<footer class="container-fluid hide">
    <div class="container ">

    </div>

</footer>



<script src="./assets/jquery/jquery-v3.6.0.min.js"></script>
<script src="./assets/jquery/jquery.validate.min.js"></script>
<script src="./assets/bootstrap/v5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="./assets/sweetalert2/sweetalert2.all.min.js"></script>
<script src="./assets/js/appbase.js"></script>

<script>

    const page = {
        urls: {
            getAllCustomers: AppBase.DOMAIN_API + "/customers?deleted=0",
            findCustomerById: AppBase.DOMAIN_API + "/customers",
            createCustomer: AppBase.DOMAIN_API + "/customers",
            updateCustomerById: AppBase.DOMAIN_API + "/customers",
            doDeposit: AppBase.API_CUSTOMER + '/deposit',
            deleteDeposit: AppBase.DOMAIN_API + '/deposit',
            deleteCustomerById: AppBase.DOMAIN_API + "/customers",
            doTransfer: AppBase.API_CUSTOMER + '/transfer',
            getAllRecipientsWithOutSender: AppBase.API_CUSTOMER + '/getAllRecipientsWithoutSender',
            doWithdraw: AppBase.API_CUSTOMER + '/withdraw'
        },
        elements: {},
        loadData: {},
        commands: {},
        dialogs: {
            elements: {},
            loadData: {},
            commands: {}
        }
    }


    let customers = [];
    let currentCustomer = null;
    let transfer = new Transfer();
    let sender = new Customer();
    let recipient = new Customer();
    let locationRegion = new LocationRegion();
    let customer = new Customer();
    let deposit = new Deposit();
    let withdraw = new Withdraw();

    page.elements.btnShowCreateModal = $('#btnShowCreateModal');


    page.dialogs.elements.modalCreate = $('#modalCreate');
    page.dialogs.elements.frmCreateCustomer = $('#frmCreateCustomer');
    page.dialogs.elements.fullNameCre = $('#fullNameCre');
    page.dialogs.elements.emailCre = $('#emailCre');
    page.dialogs.elements.phoneCre = $('#phoneCre');
    page.dialogs.elements.provinceCre = $('#provinceCre');
    page.dialogs.elements.districtCre = $('#districtCre');
    page.dialogs.elements.wardCre = $('#wardCre');
    page.dialogs.elements.addressCre = $('#addressCre');
    page.dialogs.elements.btnCreate = $('#btnCreateCustomer')

    page.dialogs.elements.modalUpdate = $('#modalUpdate');
    page.dialogs.elements.frmUpdateCustomer = $('#frmUpdateCustomer');
    page.dialogs.elements.fullNameUp = $('#fullNameUp');
    page.dialogs.elements.emailUp = $('#emailUp');
    page.dialogs.elements.phoneUp = $('#phoneUp');
    page.dialogs.elements.provinceUp = $('#provinceUp');
    page.dialogs.elements.districtUp = $('#districtUp');
    page.dialogs.elements.wardUp = $('#wardUp');
    page.dialogs.elements.addressUp = $('#addressUp');
    page.dialogs.elements.btnCreate = $('#btnUpdateCustomer')

    page.dialogs.elements.modalDeposit = $('#modalDeposit');
    page.dialogs.elements.frmDeposit = $('#frmDeposit');
    page.dialogs.elements.idDep =$('#idDep');
    page.dialogs.elements.fullNameDep =$('#fullNameDep');
    page.dialogs.elements.balanceDep =$('#balanceDep');
    page.dialogs.elements.transactionAmountDep =$('#transactionAmountDep');
    page.dialogs.elements.btnDeposit =$('#btnDeposit');

    page.dialogs.elements.modalWithdraw = $('#modalWithdraw');
    page.dialogs.elements.idWd = $('#idWd');
    page.dialogs.elements.frmWithdraw = $('#frmWithdraw');
    page.dialogs.elements.idWd =$('#idWd');
    page.dialogs.elements.fullNameWd =$('#fullNameWd');
    page.dialogs.elements.balanceWd =$('#balanceWd');
    page.dialogs.elements.transactionAmountWd =$('#transactionAmountWd');
    page.dialogs.elements.btnWithdraw =$('#btnWithdraw');


    page.loadData.getAllCustomers = () => {
        $.ajax({
            type: "GET",
            url: page.urls.getAllCustomers
        })
            .done((data) => {
                $.each(data, (i, item) => {
                    customer = item;
                    locationRegion = customer.locationRegion;
                    let str = renderCustomer(customer, locationRegion);
                    $('#tbCustomer tbody').prepend(str);
                })
                page.commands.addEventShowActionButton();

            })
            .fail((error) => {
                console.error(error);
            })
    }

    page.dialogs.loadData.getAllProvinces = () => {
        return $.ajax({
            type: 'GET',
            url: 'https://vapi.vnappmob.com/api/province/'
        })
            .done((data) => {
                $.each(data.results,(i,item)=>{
                    let str = `<option value="${item.province_id}">${item.province_name}</option>`;
                    page.dialogs.elements.provinceCre.append(str);
                })

            })
            .fail((jqXHR) => {
                AppBase.SweetAlert.showErrorAlert('Load Provinces fail');
            })
    }

    page.dialogs.loadData.getAllProvincesUp = (customer) => {
        page.dialogs.elements.provinceUp.empty();
        return $.ajax({
            type: 'GET',
            url: 'https://vapi.vnappmob.com/api/province/'
        })
            .done((data) => {
                $.each(data.results,(i,item)=>{
                    let str = null;
                    // cần kiểm tra lại b
                    if(customer.locationRegion.provinceId==item.province_id){
                        str = `<option value="${item.province_id}" selected="selected">${customer.locationRegion.provinceName}</option>`;
                        page.dialogs.elements.provinceUp.append(str);
                    }
                    else{
                        str = `<option value="${item.province_id}" >${item.province_name}</option>`;
                        page.dialogs.elements.provinceUp.append(str);
                    }
                })

            })
            .fail((jqXHR) => {
                AppBase.SweetAlert.showErrorAlert('Load Provinces fail');
            })
    }




    page.dialogs.loadData.getAllDistrictsByProvince = () => {
        page.dialogs.elements.districtCre.empty();
        let provinceId = page.dialogs.elements.provinceCre.val();

        locationRegion.provinceId = provinceId;

        console.log(provinceId);
        return $.ajax({
            type: 'GET',
            url: 'https://vapi.vnappmob.com/api/province/district/' + provinceId
        })
            .done((data) => {
                $.each(data.results,(i,item) => {
                    let str = `<option value="${item.district_id}">${item.district_name}</option>`;
                    page.dialogs.elements.districtCre.append(str);
                })
            })
            .fail((jqXHR) => {
                AppBase.SweetAlert.showErrorAlert('Load Districts fail');
            })
    }

    page.dialogs.loadData.getAllDistrictsByProvinceUp = () => {

        page.dialogs.elements.districtUp.empty();
        let provinceId = page.dialogs.elements.provinceUp.val();

        return $.ajax({
            type: 'GET',
            url: 'https://vapi.vnappmob.com/api/province/district/' + provinceId
        })
            .done((data) => {
                $.each(data.results,(i,item) => {
                    let str = null;
                    console.log(provinceId);
                    if(provinceId==item.district_id){
                        str = `<option value="${item.district_id}" select="selected">${item.district_name}</option>`;
                        page.dialogs.elements.districtUp.append(str);
                    }
                    else{
                        str = `<option value="${item.district_id}">${item.district_name}</option>`;
                        page.dialogs.elements.districtUp.append(str);
                    }

                })
            })
            .fail((jqXHR) => {
                AppBase.SweetAlert.showErrorAlert('Load Districts fail');
            })
    }


    page.dialogs.loadData.getAllWardsByDistrictUp = () => {

        page.dialogs.elements.wardCre.empty();

        let districtId = page.dialogs.elements.districtUp.val();
        // locationRegion.districtId = districtId;
        // let districtId = id;
        $.ajax({
            type: 'GET',
            url: 'https://vapi.vnappmob.com/api/province/ward/' + districtId
        })
            .done((data) => {

                $.each(data.results, (i, item) => {
                    let str = `<option value="${item.ward_id}">${item.ward_name}</option>`;

                    page.dialogs.elements.wardUp.append(str);
                })
            })
            .fail((jqXHR) => {
                AppBase.SweetAlert.showErrorAlert('Load Wards fail');
            })
    }


    page.dialogs.loadData.getAllWardsByDistrict = () => {

        page.dialogs.elements.wardCre.empty();

        let districtId = page.dialogs.elements.districtCre.val();
        // locationRegion.districtId = districtId;
        // let districtId = id;
        $.ajax({
            type: 'GET',
            url: 'https://vapi.vnappmob.com/api/province/ward/' + districtId
        })
            .done((data) => {

                $.each(data.results, (i, item) => {
                    let str = `<option value="${item.ward_id}">${item.ward_name}</option>`;

                    page.dialogs.elements.wardCre.append(str);
                })
            })
            .fail((jqXHR) => {
                AppBase.SweetAlert.showErrorAlert('Load Wards fail');
            })
    }


    page.dialogs.loadData.getAllWardsByDistrictAuto = (id) => {

        page.dialogs.elements.wardCre.empty();


        // locationRegion.districtId = districtId;
        let districtId = id;
        $.ajax({
            type: 'GET',
            url: 'https://vapi.vnappmob.com/api/province/ward/' + districtId
        })
            .done((data) => {

                $.each(data.results, (i, item) => {
                    let str = `<option value="${item.ward_id}">${item.ward_name}</option>`;

                    page.dialogs.elements.wardCre.append(str);
                })
            })
            .fail((jqXHR) => {
                AppBase.SweetAlert.showErrorAlert('Load Wards fail');
            })
    }

    page.dialogs.loadData.getAllDistrictByProvinceAuto = (customer)=>{
        page.dialogs.elements.districtUp.empty();
        return $.ajax({
            type: 'GET',
            url: 'https://vapi.vnappmob.com/api/province/district/' + customer.locationRegion.provinceId
        })
            .done((data) => {
                $.each(data.results,(i,item)=>{
                    let str = null;
                    if(customer.locationRegion.districtId==item.district_id){
                        str = `<option value="${item.district_id}" selected="selected">${customer.locationRegion.districtName}</option>`;
                        page.dialogs.elements.districtUp.append(str);
                    }
                    else{
                        str = `<option value="${item.district_id}" >${item.district_name}</option>`;
                        page.dialogs.elements.districtUp.append(str);
                    }
                })

            })
            .fail((jqXHR) => {
                AppBase.SweetAlert.showErrorAlert('Load Provinces fail');
            })
    }

    page.dialogs.loadData.getAllWardByDistrictUpAuto = (customer)=>{
        page.dialogs.elements.wardUp.empty();

        return $.ajax({
            type: 'GET',
            url: 'https://vapi.vnappmob.com/api/province/ward/'   + customer.locationRegion.districtId
        })
            .done((data) => {
                $.each(data.results,(i,item)=>{
                    let str = null;
                    if(customer.locationRegion.wardId==item.ward_id){
                        str = `<option value="${item.ward_id}" selected="selected">${customer.locationRegion.wardName}</option>`;
                        page.dialogs.elements.wardUp.append(str);
                    }
                    else{
                        str = `<option value="${item.ward_id}" >${item.ward_name}</option>`;
                        page.dialogs.elements.wardUp.append(str);
                    }
                })

            })
            .fail((jqXHR) => {
                AppBase.SweetAlert.showErrorAlert('Load ward fail');
            })
    }

    page.elements.btnShowCreateModal.on('click', () => {
        page.dialogs.elements.modalCreate.modal('show');
    })

    page.loadData.findCustomerById = (id) => {
        return $.ajax({
            type: "GET",
            url: page.urls.findCustomerById + '/' + id
        })
            .fail((error) => {
                console.error(error);
            })
    }


    let addEventUpdateCustomer = () => {
        $('.edit').on('click', function() {
            let id = $(this).data('id');
            page.loadData.findCustomerById(id).then((customer) => {
                currentCustomer = customer;

                $('#fullNameUp').val(customer.fullName);
                $('#emailUp').val(customer.email);
                $('#phoneUp').val(customer.phone);
                $('#addressUp').val(customer.locationRegion.address);


                page.dialogs.loadData.getAllProvincesUp(currentCustomer).then(() => {
// Khi province thay đổi thì district thay đổi theo

                    page.dialogs.loadData.getAllDistrictByProvinceAuto(currentCustomer);

                    page.dialogs.loadData.getAllWardByDistrictUpAuto(currentCustomer);

                    page.dialogs.elements.provinceUp.on('change', function(){

                        page.dialogs.loadData.getAllDistrictsByProvinceUp().then((data)=>{

                            // page.dialogs.loadData.getAllWardsByDistrictAuto(districtId);

                            removeEventChange();
                            page.dialogs.elements.districtUp.on('change',function(){

                                page.dialogs.loadData.getAllWardsByDistrictUp();
                                page.dialogs.elements.wardUp.empty();
                            })
                        })
                    })
                })



                $('#modalUpdate').modal('show');

            })
                .catch(() => {
                    alert('Customer not found');
                });
        })
    }

    let addEventDeleteCustomer = () => {
        $('.delete').on('click', function() {
            let id = $(this).data('id');

            AppBase.SweetAlert.showDeleteConfirmDialog().then(result => {
                if (result.isConfirmed) {
                    page.commands.deleteCustomer(id)
                    }
                })
            })
    }

    page.dialogs.commands.addEventTransfer = () =>{
        $(".transfer").on("click", function(){
            let senderId = $(this).data('id');
            console.log(senderId);
            page.loadData.findCustomerById(senderId).then((customer)=>{
                currentCustomer = customer;
                $.ajax({
                    type: "GET",
                    url: page.urls.getAllRecipientsWithOutSender + '/' + senderId
                })
                    .done((data)=>{
                        console.log("hello");
                        $('#recipientIdTrf').empty();
                        $.each(data,(i,item)=>{
                            let str = `<option value="${item.id}">(${item.id}) - ${item.fullName}</option>`;
                            $('#recipientIdTrf').append(str);
                        })
                        $("#senderIdTrf").val(currentCustomer.id);
                        $("#senderNameTrf").val(currentCustomer.fullName);
                        $("#emailTrf").val(currentCustomer.email);
                        $("#balanceTrf").val(currentCustomer.balance);

                        $("#modalTransfer").modal("show");
                    })
                    .fail((error)=>{
                        console.log(error);
                    })
            })
                .catch(() => {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'error',
                        title: 'Customer invalid',
                        showConfirmButton: false,
                        timer: 1500
                    })
                });
        })
    }

    page.dialogs.commands.addEventDeposit = () => {
        $('.deposit').on('click', function () {
            let customerId = $(this).data('id');

            page.loadData.findCustomerById(customerId).then((data) => {
                currentCustomer = data;

                page.dialogs.elements.idDep.val(currentCustomer.id);
                page.dialogs.elements.fullNameDep.val(currentCustomer.fullName);
                page.dialogs.elements.balanceDep.val(`${new Intl.NumberFormat('vi', {
                  style: 'currency',
                  currency: 'VND',
                  minimumFractionDigits: 0
              }).format(currentCustomer.balance)}`);

                // page.dialogs.elements.transactionAmountDep.keydown(function(e) {
                //     let formatedNumber = this.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                //     console.log(formatedNumber);
                //     this.value = formatedNumber;
                    // let txt = this.value;
                    //
                    // // prevent more than 12 characters, ignore the spacebar, allow the backspace
                    // if ((txt.length == 12 || e.which == 32) & e.which !== 8) e.preventDefault();
                    // // add spaces after 3 & 7 characters, allow the backspace
                    // if ((txt.length == 3 || txt.length == 7) && e.which !== 8)
                    //     this.value = this.value + " ";
                // });
                page.dialogs.elements.modalDeposit.modal('show');
            })
                .catch(() => {
                    AppBase.SweetAlert.showErrorAlert('Customer not found');
                })
        })
    }

    page.dialogs.commands.addEventWithdraw = () => {
        $('.withdraw').on('click', function () {
            let customerId = $(this).data('id');

            page.loadData.findCustomerById(customerId).then((data) => {
                currentCustomer = data;

                page.dialogs.elements.idWd.val(currentCustomer.id);
                page.dialogs.elements.fullNameWd.val(currentCustomer.fullName);
                page.dialogs.elements.balanceWd.val(currentCustomer.balance);

                page.dialogs.elements.modalWithdraw.modal('show');
            })
                .catch(() => {
                    AppBase.SweetAlert.showErrorAlert('Customer not found');
                })
        })
    }

    page.commands.addEventShowActionButton = ()=>{
        $('#tbCustomer tbody tr').on('click', function (){

            $('#tbCustomer tbody tr').find('td:eq(0)').find('span').removeClass('selected').addClass('unselected');

            // $(this).find('td').first().find('span').removeClass('selected').addClass('unselected');

            $(this).find('td').first().find('span').removeClass('unselected').addClass('selected');

            let currentCustomerId = $(this).attr('id').replace("tr_","")
            let str = `
                    <button class="btn btn-secondary edit" data-id="${currentCustomerId}">
                        <i class="far fa-edit"></i>
                        Update
                    </button>
                    <button class="btn btn-success deposit" data-id="${currentCustomerId}">
                        <i class="fas fa-plus"></i>
                        Deposit
                    </button>
                    <button class="btn btn-warning withdraw" data-id="${currentCustomerId}">
                        <i class="fas fa-minus"></i>
                        Withdraw
                    </button>
                    <button class="btn btn-primary transfer" data-id="${currentCustomerId}">
                        <i class="fas fa-exchange-alt"></i>
                        Transfer
                    </button>
                    <button class="btn btn-danger delete" data-id="${currentCustomerId}">
                        <i class="fas fa-trash-alt"></i>
                        Delete
                    </button>
                `

            $('footer').removeClass('hide');
            $('footer .container').html(str);
            addEventUpdateCustomer();
            page.dialogs.commands.addEventDeposit();
            addEventDeleteCustomer();
            page.dialogs.commands.addEventWithdraw();
            page.dialogs.commands.addEventTransfer();
            page.commands.addEventFooterButton();

        })
    }

    page.commands.addEventFooterButton = ()=>{
        $('footer button').on('click', ()=>{
            $('footer').addClass('hide');
            $('footer .container').empty();
        })
    }

    page.commands.checkCustomerById = (id) => {
        return $.ajax({
            type: 'PATCH',
            url: page.urls.findCustomerById + '/' + id
        })
            .fail((error) => {
                console.log(error);
            })
    }

    page.commands.deleteCustomer = (id) => {
        $.ajax({
            headers: {
                'accept': 'application/json',
                'content-type': 'application/json'
            },
            type: 'DELETE',
            url: page.urls.deleteCustomerById + '/' + id,
            data: JSON.stringify(id)
        })
            .done(() => {

                $('#tr_' + id).remove();

                Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: 'Customer has been deleted.',
                    showConfirmButton: false,
                    timer: 2000
                })
            })
            .fail(() => {
                Swal.fire({
                    position: 'center',
                    icon: 'error',
                    title: 'Failed to delete customer! You dont have the authority to perform ',
                })
            })
    }

    let removeEventCreateCustomer = () => {
        $('.edit').off('click');
    }

    let removeEventDeleteCustomer = () => {
        $('.delete').off('click');
    }

    let removeEventTest = ()=>{
        page.dialogs.elements.districtCre.off('change');
    }

    let removeEventChange = ()=>{
        page.dialogs.elements.districtUp.off('change');
    }



    let doCreateCustomer = () => {
        // let id = generateId();
        let fullName = page.dialogs.elements.fullNameCre.val();
        let email = page.dialogs.elements.emailCre.val();
        let phone = page.dialogs.elements.phoneCre.val();
        let provinceId = page.dialogs.elements.provinceCre.val();
        let provinceName = page.dialogs.elements.provinceCre.find('option:selected').text();
        let districtId = page.dialogs.elements.districtCre.val();
        let districtName = page.dialogs.elements.districtCre.find('option:selected').text();
        let wardId = page.dialogs.elements.wardCre.val();
        let wardName = page.dialogs.elements.wardCre.find('option:selected').text();
        let address = page.dialogs.elements.addressCre.val();
        let balance = 0;
        let deleted = 0;

        // locationRegion.id = null;
        locationRegion.provinceId = provinceId;
        locationRegion.provinceName = provinceName;
        locationRegion.districtId = districtId;
        locationRegion.districtName = districtName;
        locationRegion.wardId = wardId;
        locationRegion.wardName = wardName;
        locationRegion.address = address;

        customer.id = null;
        customer.fullName = fullName;
        customer.email = email;
        customer.phone = phone;
        customer.locationRegion = locationRegion;
        customer.balance = balance;
        customer.deleted = deleted;

        // customers.push(customer);

        $.ajax({
            headers: {
                'accept': 'application/json',
                'content-type': 'application/json'
            },
            type: "POST",
            url: page.urls.createCustomer,
            data: JSON.stringify(customer)
        })
            .done((data) => {
                customer = data;
                locationRegion = customer.locationRegion;

                let str = renderCustomer(customer, locationRegion);
                $('#tbCustomer tbody').prepend(str);

                page.commands.addEventShowActionButton();

                $('#modalCreate').modal('hide');

                AppBase.SweetAlert.showSuccessAlert('New customer is created successfully');
            })
            .fail((jqXHR) => {
                // Cách in lỗi ra màn hình
                if (jqXHR.status === 409) {
                    alert("409");
                }
                if (jqXHR.status === 400) {
                    let errors = jqXHR.responseJSON;
                    let str = "";
                    $.each(errors, (k, v) => {
                        str += `<label for="${k}Cre">${v}</label>`;
                    })

                    $('#modalCreate .modal-body .modal-alert-danger').append(str);
                    $('#modalCreate .modal-body .modal-alert-danger').removeClass('hide').addClass('show');
                }


            })
    }

    $('#btnCreateCustomer').on('click', () => {
        $('#frmCreateCustomer').trigger('submit');
    })


    $('#btnUpdateCustomer').on('click', () => {
        let id = currentCustomer.id;
        let fullName = $('#fullNameUp').val();
        let email = $('#emailUp').val();
        let phone = $('#phoneUp').val();

        let address = $('#addressUp').val();
        let province = $('#provinceUp').val();
        let district = $('#districtUp').val();
        let ward = $('#wardUp').val();
        let provinceName  = $('#provinceUp option:selected').text();
        let districtName  = $('#districtUp option:selected').text();
        let wardName  = $('#wardUp option:selected').text();



        currentCustomer.fullName = fullName;
        currentCustomer.email = email;
        currentCustomer.phone = phone;
        currentCustomer.locationRegion.address = address;
        currentCustomer.locationRegion.provinceId = province;
        currentCustomer.locationRegion.wardId = ward;
        currentCustomer.locationRegion.provinceName = provinceName;
        currentCustomer.locationRegion.districtName = districtName;
        currentCustomer.locationRegion.wardName = wardName



        $.ajax({
            headers: {
                'accept': 'application/json',
                'content-type': 'application/json'
            },
            type: 'PATCH',
            url: page.urls.updateCustomerById + '/' + id,
            data: JSON.stringify(currentCustomer)
        })
            .done((data) => {
                currentCustomer = data;

                locationRegion = currentCustomer.locationRegion
                let newRow = renderCustomer(currentCustomer,locationRegion);
                let currentRow = $('#tr_' + id);

                currentRow.replaceWith(newRow);

                removeEventCreateCustomer();
                addEventUpdateCustomer();
                page.commands.addEventShowActionButton();
                $('#modalUpdate').modal('hide');
                AppBase.SweetAlert.showSuccessAlert('Customer is updated  successfully');
            })
            .fail((jqXHR) => {
                let errors = jqXHR.responseJSON;
                let str = "";
                $.each(errors, (k, v) => {
                    str += `<label for="${k}Up">${v}</label>`;
                })

                $('#modalUpdate .modal-body .modal-alert-danger').append(str);
                $('#modalUpdate .modal-body .modal-alert-danger').removeClass('hide').addClass('show');
                    // Thông báo ko đủ authority để update
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'Failed to delete customer',
                    })

            })

    })

    $('#btnTransfer').on('click', () => {
        console.log("doTransfer")
        let senderId = +$('#senderIdTrf').val();
        let recipientId = +$('#recipientIdTrf').val();
        let transferAmount = +$('#transferAmountTrf').val();

        sender.id = senderId;
        recipient.id = recipientId;

        // page.loadData.findCustomerById(senderId).then((sender)=>{
        //     transfer.sender = sender;
        // })
        //
        // page.loadData.findCustomerById(recipientId).then((recipient)=>{
        //     transfer.recipient = recipient;
        // })

        transfer.sender = sender;
        transfer.recipient = recipient;
        transfer.transferAmount = transferAmount;

        $.ajax({
            headers: {
                'accept': 'application/json',
                'content-type': 'application/json'
            },
            type: 'POST',
            url: page.urls.doTransfer,
            data: JSON.stringify(transfer)
        })
            .done((data) => {
                let sender = data.sender;
                let locationRegionSender = sender.locationRegion;
                let recipient = data.recipient;
                let locationRegionRecipient = recipient.locationRegion;

                let currentRowSender = $("#tr_" + sender.id);
                let newRowSender = renderCustomer(sender,locationRegionSender);

                currentRowSender.replaceWith(newRowSender);

                let currentRowRecipient = $("#tr_" + recipient.id);
                let newRowRecipient = renderCustomer(recipient,locationRegionRecipient);

                currentRowRecipient.replaceWith(newRowRecipient);
                page.commands.addEventShowActionButton();
                $("#modalTransfer").modal('hide');

                Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: 'Transfer successful',
                    showConfirmButton: false,
                    timer: 1500
                })
            })
            .fail((jqXHR) => {

                let messageError = jqXHR.responseJSON.message;

                Swal.fire({
                    position: 'top-end',
                    icon: 'error',
                    title: messageError
                })
            })

    })

    $('#transferAmountTrf').on("input", () => {
        let transferAmount = $('#transferAmountTrf').val();
        let fees = 10;
        let feesAmount = +transferAmount * fees / 100;
        let transactionAmount = +transferAmount + feesAmount;

        $("#transactionAmountTrf").val(transactionAmount);
    })

    page.dialogs.elements.btnDeposit.on('click', (e) => {
        // // e.preventDefault();
        // let transactionAmountDep = +page.dialogs.elements.transactionAmountDep.val().replaceAll(" ", "");
        // page.dialogs.elements.transactionAmountDep.val(transactionAmountDep);

        page.dialogs.elements.frmDeposit.trigger('submit');
    })


    page.dialogs.commands.doDeposit = () => {
        let currentBalance = currentCustomer.balance;
        let transactionAmountDep = +page.dialogs.elements.transactionAmountDep.val();
        let newBalance = currentBalance + transactionAmountDep;
        currentCustomer.balance = newBalance;
        // deposit.id = null;
        deposit.customerId = currentCustomer.id;
        deposit.transactionAmount = transactionAmountDep;
        page.dialogs.commands.createDeposit()
    }

    page.dialogs.commands.createDeposit = () => {
        return $.ajax({
            headers: {
                'accept': 'application/json',
                'content-type': 'application/json'
            },
            type: 'POST',
            url: page.urls.doDeposit + "/" + currentCustomer.id,
            data: JSON.stringify(deposit)
        })
            .done((data) => {
                customer = data;
                locationRegion = customer.locationRegion;
                let currentRow = $('#tr_' + customer.id);
                let newRow = renderCustomer(customer, locationRegion);
                currentRow.replaceWith(newRow);
                AppBase.SweetAlert.showSuccessAlert('Deposit success');
                page.dialogs.elements.modalDeposit.modal('hide');
                page.commands.addEventShowActionButton();
            })
            .fail((jqXHR) => {
                let errors = jqXHR.responseJSON;
                let str = "";
                $.each(errors, (k, v) => {
                    str += `<label for="${k}Dep">${v}</label>`;
                })

                $('#modalDeposit .modal-body .modal-alert-danger').append(str);
                $('#modalDeposit .modal-body .modal-alert-danger').removeClass('hide').addClass('show');
            });
    }

    page.dialogs.commands.incrementCustomerBalance = (customer) => {
        return $.ajax({
            headers: {
                'accept': 'application/json',
                'content-type': 'application/json'
            },
            type: 'PATCH',
            url: page.urls.updateCustomerById + '/' + customer.id,
            data: JSON.stringify(customer)
        })
    }

    page.dialogs.commands.deleteDeposit = () => {
        $.ajax({
            headers: {
                'accept': 'application/json',
                'content-type': 'application/json'
            },
            type: 'DELETE',
            url: page.urls.deleteDeposit + '/' + deposit.id
        })
    }

    page.dialogs.elements.btnWithdraw.on('click', (e) => {
        page.dialogs.elements.frmWithdraw.trigger('submit');
    })

    page.dialogs.commands.doWithdraw = () =>{
        let transactionAmount = +page.dialogs.elements.transactionAmountWd.val();
        withdraw.id = null;
        withdraw.transactionAmount = transactionAmount;
        withdraw.customerId = currentCustomer.id;
        page.dialogs.commands.createWithdraw();
    }


    page.dialogs.commands.createWithdraw = ()=>{
        return $.ajax({
            headers: {
                'accept': 'application/json',
                'content-type': 'application/json'
            },
            type: 'POST',
            url: page.urls.doWithdraw + "/" + currentCustomer.id,
            data: JSON.stringify(withdraw)
        })
            .done((data) => {
                console.log('hello')
                customer = data;
                locationRegion = customer.locationRegion;
                let currentRow = $('#tr_' + customer.id);
                let newRow = renderCustomer(customer, locationRegion);
                currentRow.replaceWith(newRow);
                AppBase.SweetAlert.showSuccessAlert('Withdraw success');
                page.dialogs.elements.modalWithdraw.modal('hide');
                page.commands.addEventShowActionButton();
            })
            .fail((jqXHR) => {
                let errors = jqXHR.responseJSON;
                let str = "";
                $.each(errors, (k, v) => {
                    str += `<label for="${k}Dep">${v}</label>`;
                })

                $('#modalWithdraw .modal-body .modal-alert-danger').append(str);
                $('#modalWithdraw .modal-body .modal-alert-danger').removeClass('hide').addClass('show');
            });
    }


    let renderCustomer = (customer, locationRegion) => {
        return `
                <tr class="customerId" data-id=${customer.id} id="tr_${customer.id}">
                    <td><span class="select-tab unselected"></span></td>
                    <td>${customer.id}</td>
                    <td>${customer.fullName}</td>
                    <td>${customer.email}</td>
                    <td>${customer.phone}</td>
                    <td>${new Intl.NumberFormat('vi', {
            style: 'currency',
            currency: 'VND',
            minimumFractionDigits: 0
        }).format(customer.balance)}

                    </td>
                    <td>${locationRegion.provinceName}</td>
                    <td>${locationRegion.districtName}</td>
                    <td>${locationRegion.wardName}</td>
                    <td>${locationRegion.address}</td>
                </tr>
            `;
    }


    $('#modalCreate').on('hidden.bs.modal', () => {
        $('#frmCreateCustomer')[0].reset();
        $('#frmCreateCustomer').validate().resetForm();

        $('#modalCreate .modal-alert-danger').empty().removeClass("show").addClass("hide");
        $('#frmCreateCustomer').find("input.error").removeClass("error");
    })

    $('#modalDeposit').on('hidden.bs.modal', () => {
        $('#frmDeposit')[0].reset();
        $('#frmDeposit').validate().resetForm();
        $('#frmDeposit .modal-alert-danger').empty().removeClass("show").addClass("hide");
        $('#frmDeposit').find("input.error").removeClass("error");
    })

    $('#frmCreateCustomer').validate({
        rules: {
            fullNameCre: {
                required: true,
                minlength: 5,
                maxlength: 20
            },
            emailCre: {
                required: true,
                minlength: 5,
                maxlength: 40
            }
        },
        messages: {
            fullNameCre: {
                required: 'Full name is required',
                minlength: 'Min character of full name is ${0}',
                maxlength: 'Max character of full name is ${0}'
            },
            emailCre: {
                required: 'Email is required',
                minlength: 'Min character of email is ${0}',
                maxlength: 'Max character of email is ${0}'
            }
        },
        errorLabelContainer: "#modalCreate .modal-alert-danger",
        errorPlacement: function (error, element) {
            error.appendTo("#modalCreate .modal-alert-danger");
        },
        showErrors: function(errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalCreate .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalCreate .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmCreateCustomer input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            doCreateCustomer();
        }
    });


    page.dialogs.elements.frmDeposit.validate({

        rules: {
            transactionAmountDep: {
                required: true,
                number: true,
                min: 1000,
                max: 1000000
            }
        },
        messages: {
            transactionAmountDep: {
                required: 'Transaction amount is required',
                number: 'Transaction amount must be number',
                min: 'Transaction amount must be more than ${0}',
                max: 'Transaction amount must be less than ${0}'
            }
        },
        errorLabelContainer: "#modalDeposit .modal-alert-danger",
        errorPlacement: function (error, element) {
            error.appendTo("#modalDeposit .modal-alert-danger");
        },
        showErrors: function(errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalDeposit .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalDeposit .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmDeposit input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            page.dialogs.commands.doDeposit();
        }
    });

    page.dialogs.elements.frmWithdraw.validate({
        rules: {
            transactionAmountWd: {
                required: true,
                number: true,
                min: 1000,
                max: 1000000
            }
        },
        messages: {
            transactionAmountWd: {
                required: 'Transaction amount is required',
                number: 'Transaction amount must be number',
                min: 'Transaction amount must be more than ${0}',
                max: 'Transaction amount must be less than ${0}'
            }
        },
        errorLabelContainer: "#modalWithdraw .modal-alert-danger",
        errorPlacement: function (error, element) {
            error.appendTo("#modalWithdraw .modal-alert-danger");
        },
        showErrors: function(errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalWithdraw .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalWithdraw .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmWithdraw input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            page.dialogs.commands.doWithdraw();
        }
    });


    $(() => {
        page.loadData.getAllCustomers();


//          Nhớ remove sự kiện vì nếu kich một laan nữa sẽ bị chồng sự kiện change
// ví dụ kich 3 lần thay đổi ở province mà ko kich district sẽ bị dồn 3 lần sự kiện change ở districtcre
        page.dialogs.loadData.getAllProvinces().then(() => {
            let districtId = null;

            page.dialogs.elements.provinceCre.on('change', function(){

                page.dialogs.loadData.getAllDistrictsByProvince().then((data)=>{

                    districtId = page.dialogs.elements.districtCre.val();

                    page.dialogs.loadData.getAllWardsByDistrictAuto(districtId);

                    removeEventTest();
                    page.dialogs.elements.districtCre.on('change',function(){

                        console.log("hello");
                        page.dialogs.loadData.getAllWardsByDistrict();
                        page.dialogs.elements.wardCre.empty();
                    })
                })
            })

            // page.dialogs.elements.districtCre.change(function(){
            // console.log('ward change');

            // page.dialogs.loadData.getAllWardsByDistrict();
            // })


            // let provinceId = page.dialogs.elements.provinceCre.find('option:eq(1)').prop('selected', true).val();

            // page.dialogs.loadData.getAllDistrictsByProvince(provinceId).then(() => {
            //     let districtId = page.dialogs.elements.districtCre.find('option:eq(1)').prop('selected', true).val();

            //     page.dialogs.loadData.getAllWardsByDistrict(districtId);
            // });
        });


    })


</script>

</body>
</html>